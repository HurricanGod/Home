































































































# Redis持久化



`Redis`过期键的判定：

+ 检查给定键是否存在于过期字典中
  + 如果存在，获取过期键的过期时间，检查当前Unix过期时间戳是否大于键的过期时间
    + 如果大于说明键已过期
    + 否则未过期



**过期键删除策略**：

+ **定时删除**

  + 设置键过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立刻执行对键的删除操作
  + **优点** ：对内存友好，对过期的键尽可能快删除
  + **缺点**：对CPU时间不友好，在CPU紧张时会影响相应时间和吞吐量

  ​

+ **惰性删除**

  + 放任键过期不管，但是每次在**键空间**读取键时检测键有没有过期，如果过期了直接删除键，没有过期则返回该键
  + **缺点**：过期键如果一直未被访问将永远不会删除，会造成内存泄漏



+ **定期删除**
  + 每隔一段时间程序对数据库进行一次检查，删除里面过期的键

----

## RDB持久化

`Redis`中生成RDB文件的两个命令：

+ `save` —— 会阻塞Redis服务器进程，直到RDB文件创建完毕为止，在服务器进程阻塞期间不能处理任何命令请求
+ `bgsave` —— 派生1个子进程然后由子进程负责创建RDB文件，**服务器进程会进行处理命令请求**

>执行`save`命令或者`bgsave`命令时会创建一个**新的`RDB`文件**，程序会对数据库中的键进行检查，已过期的键将不会被保存到新创建的RDB文件中



`rdb`方式的持久化是通过快照完成的，当符合一定条件时redis会自动将内存中的所有数据执行快照操作并存储到硬盘上。

配置Redis服务器的save选项，让服务器每隔一段时间执行一次 `bgsave`命令：

```sh
save 900 1
save 300 10
save 60 10000
```

+ 服务器在900s内对数据库进行了至少1次修改将会执行`bgsave`命令
+ 服务器在300s内对数据库进行了至少10次修改将会执行`bgsave`命令
+ 服务器在60s内对数据库进行了至少10000次修改将会执行`bgsave`命令



**RDB文件结构**：

![](https://github.com/HurricanGod/Home/blob/master/redis/img/rdb.jpg)

+ 载入RDB文件时，程序读到`SELECTDB`时就知道接下来要把数据加载到哪个数据库
+ 程序读入`db_number`后，服务器将调用`select`命令切换数据库

-----

### 载入RDB文件

+ RDB文件的载入在服务器启动时只要检测到文件就会自动载入，如果开启了AOF持久化功能，服务器会**优先使用AOF文件**来**还原数据库状态**
+ 服务器在载入RDB文件期间，会一直处于阻塞状态，直到载入工作完成为止


+ 服务器以主服务器模式运行，在载入RDB文件时，程序会对文件中保存的键进行检查，未过期的键会被载入到数据库，过期的键会被忽略，过期键对载入RDB文件的主服务器不会造成影响
+ 从模式运行的服务器在载入RDB文件时不管过不过期都载入，主从服务器进行数据同步时，从服务器的数据就会被清空，过期键对载入RDB文件的从服务器不会造成影响








----

## **AOF**方式

+ `AOF`方式的持久化是通过**日志文件**的方式。默认情况下redis没有开启aof，可以通过参数**appendonly**参数开启
+ 执行 `AOF` 重写过程中，程序会对数据库中的键进行检查，**已过期**的key不会被保存到重写后的`AOF`文件中
+ 过期键被惰性删除或定时删除，程序会先`AOF`文件追加一条删除命令





